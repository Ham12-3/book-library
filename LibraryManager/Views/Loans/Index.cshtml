@model IEnumerable<LibraryManager.Models.Loan>

@{
    ViewData["Title"] = "Index";
}

<h1>Loans</h1>

@if (TempData["SuccessMessage"] is string successMessage)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @successMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["ErrorMessage"] is string errorMessage)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @errorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (TempData["InfoMessage"] is string infoMessage)
{
    <div class="alert alert-warning alert-dismissible fade show" role="alert">
        @infoMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <a class="btn btn-primary" asp-controller="Books" asp-action="Index">Start New Loan</a>
    <a class="btn btn-outline-secondary" asp-action="Create">Manual Entry</a>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Cover</th>
            <th>Book</th>
            <th>Member</th>
            <th>@Html.DisplayNameFor(model => model.BorrowedOn)</th>
            <th>@Html.DisplayNameFor(model => model.DueOn)</th>
            <th>@Html.DisplayNameFor(model => model.ReturnedOn)</th>
            <th>Status</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@foreach (var item in Model.OrderBy(l => l.IsReturned).ThenByDescending(l => l.BorrowedOn)) {
        <tr class="@(item.IsReturned ? string.Empty : (item.DueOn < DateTime.Today ? "table-danger" : ""))">
            <td>
                @if (!string.IsNullOrEmpty(item.Book?.CoverImagePath))
                {
                    <img src="@item.Book.CoverImagePath" alt="@item.Book?.Title cover" class="img-thumbnail" style="width: 50px; height: 75px; object-fit: cover;" />
                }
                else
                {
                    <span class="text-muted small">â€”</span>
                }
            </td>
            <td>@(item.Book?.Title ?? "Unknown Book")</td>
            <td>@(item.Member?.FullName ?? "Unknown Member")</td>
            <td>@item.BorrowedOn.ToShortDateString()</td>
            <td>@item.DueOn.ToShortDateString()</td>
            <td>@(item.ReturnedOn?.ToShortDateString() ?? "-")</td>
            <td>
                @if (item.IsReturned)
                {
                    <span class="badge bg-success">Returned</span>
                }
                else if (item.DueOn < DateTime.Today)
                {
                    <span class="badge bg-danger">Overdue</span>
                }
                else
                {
                    <span class="badge bg-warning text-dark">Checked out</span>
                }
            </td>
            <td class="text-nowrap">
                <a class="btn btn-sm btn-outline-secondary" asp-action="Details" asp-route-id="@item.Id">Details</a>
                <a class="btn btn-sm btn-outline-primary" asp-action="Edit" asp-route-id="@item.Id">Edit</a>
                <a class="btn btn-sm btn-outline-danger" asp-action="Delete" asp-route-id="@item.Id">Delete</a>
                @if (!item.IsReturned)
                {
                    <form asp-action="Return" asp-route-id="@item.Id" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm btn-success">Return</button>
                    </form>
                }
            </td>
        </tr>
}
    </tbody>
</table>
